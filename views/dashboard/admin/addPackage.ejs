<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Create New Package - Chasing Horizons Admin</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="/css/dashboard/admin/sidebar.css"
    />
    <link
      rel="stylesheet"
      href="/css/dashboard/admin/topbar.css"
    />
    <link
      rel="stylesheet"
      href="/css/dashboard/admin/styles.css"
    />
    <link
      rel="stylesheet"
      href="/css/dashboard/admin/packages.css"
    />
    <link
      rel="stylesheet"
      href="/css/dashboard/admin/package.css"
    />
  </head>

  <body>
    <div class="container">
      <div class="sidebar" id="sidebar">
        <div
          class="logo-title"
          onclick="window.location.href='/'"
        >
          <span>Chasing Horizons</span>
        </div>
        <div class="sidebar-links">
          <a href="/dashboard/admin"
            ><i class="fas fa-tachometer-alt"></i
            ><span class="link-text">Overview</span></a
          >
          <a href="/dashboard/admin/packages" class="active"
            ><i class="fas fa-chart-bar"></i
            ><span class="link-text active">Packages</span></a
          >
          <a href="/dashboard/admin/hotelManagement"
            ><i class="fas fa-hotel"></i
            ><span class="link-text">Hotel Management</span></a
          >
          <a href="/dashboard/admin/queries"
            ><i class="fas fa-question-circle"></i
            ><span class="link-text">Queries</span></a
          >
        </div>
      </div>

      <main class="main">
        <div class="topbar">
          <button class="toggle-btn" id="toggle-sidebar">
            <i style="color: black" class="fas fa-bars"></i>
          </button>
          <div class="user-info">
            <div class="user-avatar">AD</div>
            <div class="user-name">Admin</div>
          </div>
        </div>

        <!-- CREATE PACKAGE FORM -->
        <form id="create-package-form">
          <h2>Create New Package</h2>

          <label for="title">Title:</label>
          <input
            type="text"
            id="title"
            name="title"
            required
          /><br />

          <label for="tags">Tags (comma-separated):</label>
          <input type="text" id="tags" name="tags" /><br />

          <label for="mainImage">Main Image URL:</label>
          <input
            type="text"
            id="mainImage"
            name="mainImage"
          /><br />

          <label for="images"
            >Other Images (comma-separated):</label
          >
          <input type="text" id="images" name="images" /><br />

          <label for="rating">Rating:</label>
          <input
            type="number"
            id="rating"
            name="rating"
            step="0.1"
            min="1"
            max="5"
          /><br />

          <label for="duration">Duration:</label>
          <input
            type="text"
            id="duration"
            name="duration"
          /><br />

          <label for="startLocation">Start Location:</label>
          <input
            type="text"
            id="startLocation"
            name="startLocation"
          /><br />

          <label for="description">Description:</label><br />
          <textarea
            id="description"
            name="description"
          ></textarea
          ><br />

          <label for="language">Language:</label>
          <input
            type="text"
            id="language"
            name="language"
          /><br />

          <label for="priceAmount">Price (Amount):</label>
          <input
            type="number"
            id="priceAmount"
            name="priceAmount"
          /><br />

          <label for="priceDiscount"
            >Price Discount (e.g., 0.15):</label
          >
          <input
            type="number"
            id="priceDiscount"
            name="priceDiscount"
            step="0.01"
          /><br />

          <label for="includes"
            >Includes (comma-separated):</label
          >
          <input
            type="text"
            id="includes"
            name="includes"
          /><br />

          <label for="availableMonths"
            >Available Months (comma-separated):</label
          >
          <input
            type="text"
            id="availableMonths"
            name="availableMonths"
          /><br />

          <label for="status">Status:</label>
          <select id="status" name="status">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option></select
          ><br />

          <h3>Destinations</h3>
          <div id="destination-container"></div>
          <button
            class="form-button"
            type="button"
            onclick="addDestination()"
          >
            Add Destination
          </button>
          <button
            class="form-button"
            type="button"
            onclick="removeDestination()"
          >
            Remove Last Destination
          </button>

          <h3>Itinerary</h3>
          <div id="itinerary-container"></div>
          <button
            class="form-button"
            type="button"
            onclick="addItinerary()"
          >
            Add Itinerary Day
          </button>
          <button
            class="form-button"
            type="button"
            onclick="removeItinerary()"
          >
            Remove Last Itinerary Day
          </button>

          <h3>Booking Details</h3>
          <div id="booking-container"></div>
          <button
            class="form-button"
            type="button"
            onclick="addBooking()"
          >
            Add Booking
          </button>
          <button
            class="form-button"
            type="button"
            onclick="removeBooking()"
          >
            Remove Last Booking
          </button>

          <div style="margin-top: 2rem; text-align: right">
            <button class="form-button" type="submit">
              Create Package
            </button>
          </div>
        </form>
      </main>
    </div>

    <script>
      let destinationIndex = 0;
      let itineraryIndex = 0;
      let bookingIndex = 0;

      function addDestination() {
        const container = document.getElementById(
          "destination-container"
        );
        container.insertAdjacentHTML(
          "beforeend",
          `
        <fieldset class="destination-entry">
          <legend>Destination ${destinationIndex + 1}</legend>
          <label>Name:</label>
          <input type="text" name="destinations[${destinationIndex}][name]" />
          <label>Image URL:</label>
          <input type="text" name="destinations[${destinationIndex}][image]" />
        </fieldset>
      `
        );
        destinationIndex++;
      }

      function removeDestination() {
        const container = document.getElementById(
          "destination-container"
        );
        if (container.lastElementChild) {
          container.removeChild(container.lastElementChild);
          destinationIndex--;
        }
      }

      function addItinerary() {
        const container = document.getElementById(
          "itinerary-container"
        );
        container.insertAdjacentHTML(
          "beforeend",
          `
        <fieldset class="itinerary-entry">
          <legend>Day ${itineraryIndex + 1}</legend>
          <label>Day:</label>
          <input type="number" name="itinerary[${itineraryIndex}][day]" />
          <label>Location:</label>
          <input type="text" name="itinerary[${itineraryIndex}][location]" />
          <label>Activities (comma separated):</label>
          <input type="text" name="itinerary[${itineraryIndex}][activities]" />
        </fieldset>
      `
        );
        itineraryIndex++;
      }

      function removeItinerary() {
        const container = document.getElementById(
          "itinerary-container"
        );
        if (container.lastElementChild) {
          container.removeChild(container.lastElementChild);
          itineraryIndex--;
        }
      }

      function addBooking() {
        const container = document.getElementById(
          "booking-container"
        );
        container.insertAdjacentHTML(
          "beforeend",
          `
        <fieldset class="booking-entry">
          <legend>Booking ${bookingIndex + 1}</legend>
          <label>Start Date:</label>
          <input type="text" name="bookingDetails[${bookingIndex}][startDate]" />
          <label>Start Day:</label>
          <input type="text" name="bookingDetails[${bookingIndex}][startDay]" />
          <label>End Date:</label>
          <input type="text" name="bookingDetails[${bookingIndex}][endDate]" />
          <label>End Day:</label>
          <input type="text" name="bookingDetails[${bookingIndex}][endDay]" />
          <label>Status:</label>
          <input type="text" name="bookingDetails[${bookingIndex}][status]" />
          <label>Discount:</label>
          <input type="number" step="0.01" name="bookingDetails[${bookingIndex}][discount]" />
        </fieldset>
      `
        );
        bookingIndex++;
      }

      function removeBooking() {
        const container = document.getElementById(
          "booking-container"
        );
        if (container.lastElementChild) {
          container.removeChild(container.lastElementChild);
          bookingIndex--;
        }
      }

      // üöÄ Handle form submission (POST)
      document
        .getElementById("create-package-form")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const formData = new FormData(this);
          const data = Object.fromEntries(formData.entries());

          data.tags = data.tags
            ? data.tags.split(",").map((t) => t.trim())
            : [];
          data.images = data.images
            ? data.images.split(",").map((i) => i.trim())
            : [];
          data.includes = data.includes
            ? data.includes.split(",").map((i) => i.trim())
            : [];
          data.availableMonths = data.availableMonths
            ? data.availableMonths
                .split(",")
                .map((m) => m.trim())
            : [];

          data.destinations = Array.from(
            document.querySelectorAll(".destination-entry")
          ).map((entry) => ({
            name: entry.querySelector('input[name$="[name]"]')
              .value,
            image: entry.querySelector('input[name$="[image]"]')
              .value,
          }));

          data.itinerary = Array.from(
            document.querySelectorAll(".itinerary-entry")
          ).map((entry) => ({
            day: parseInt(
              entry.querySelector('input[name$="[day]"]').value
            ),
            location: entry.querySelector(
              'input[name$="[location]"]'
            ).value,
            activities: entry
              .querySelector('input[name$="[activities]"]')
              .value.split(",")
              .map((a) => a.trim()),
          }));

          data.bookingDetails = Array.from(
            document.querySelectorAll(".booking-entry")
          ).map((entry) => ({
            startDate: entry.querySelector(
              'input[name$="[startDate]"]'
            ).value,
            startDay: entry.querySelector(
              'input[name$="[startDay]"]'
            ).value,
            endDate: entry.querySelector(
              'input[name$="[endDate]"]'
            ).value,
            endDay: entry.querySelector(
              'input[name$="[endDay]"]'
            ).value,
            status: entry.querySelector(
              'input[name$="[status]"]'
            ).value,
            discount: parseFloat(
              entry.querySelector('input[name$="[discount]"]')
                .value
            ),
          }));

          data.price = {
            currency: "USD", // default or choose dynamically
            amount: parseFloat(data.priceAmount || 0),
            discount: parseFloat(data.priceDiscount || 0),
          };

          try {
            const res = await fetch("/tours/api/tour", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });

            if (res.ok) {
              alert("‚úÖ Package created successfully!");
              window.location.href = "/dashboard/admin/packages";
            } else {
              const err = await res.json();
              alert(`‚ùå Error: ${err.message}`);
            }
          } catch (err) {
            console.error(err);
            alert(
              "An error occurred while creating the package."
            );
          }
        });
    </script>
  </body>
</html>
