<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <link rel="icon" href="data:," />
    <link
      href="/css/dashboard/user/styles.css"
      rel="stylesheet"
    />
    <link
      href="/css/dashboard/user/navBar.css"
      rel="stylesheet"
    />
    <link
      href="/css/dashboard/user/sidebar.css"
      rel="stylesheet"
    />
    <link
      href="/css/dashboard/user/myTrips.css"
      rel="stylesheet"
    />
    <link href="/css/header.css" rel="stylesheet" />
    <script defer src="/js/header.js"></script>
    <script defer src="/js/dashboard/user/myTrips.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <title>Chasing Horizons - Tour Bookings</title>
  </head>

  <body>
    <div class="app-container">
      <header>
        <%- include('../../partials/header.ejs') %>
      </header>

      <div class="main-content">
        <nav class="sidebar">
          <a
            href="/dashboard"
            class="nav-item"
            data-tab="overview"
          >
            <i class="fas fa-globe"></i>
            <span>Overview</span>
          </a>
          <a
            href="/dashboard/bookings/analytics"
            class="nav-item"
            data-tab="bookings"
          >
            <i class="fas fa-chart-bar"></i>
            <span>Booking Analytics</span>
          </a>
          <a
            href="/dashboard/bookings/hotels"
            class="nav-item"
            data-tab="hotel-bookings"
          >
            <i class="fas fa-bed"></i>
            <span>Hotel Bookings</span>
          </a>
          <a
            href="/dashboard/bookings/tours"
            class="nav-item active"
            data-tab="tour-bookings"
          >
            <i class="fas fa-map-marked-alt"></i>
            <span>Tour Bookings</span>
          </a>
          <a
            href="/dashboard/settings"
            class="nav-item"
            data-tab="settings"
          >
            <i class="fas fa-cog"></i>
            <span>Settings</span>
          </a>
        </nav>

        <main class="dashboard-myTrips">
          <div class="dashboard-header">
            <h1 class="dashboard-title">
              <i class="fas fa-map-marked-alt"></i> Tour Bookings
            </h1>
            <button
              onclick="window.location.href = `/tours` "
              class="btn btn-primary"
            >
              <span>+</span> Book Tour
            </button>
          </div>

          <!-- Error/Message Display -->
          <% if (typeof error !== 'undefined' && error) { %>
          <div class="alert alert-error" style="background-color: #fee; border: 1px solid #fcc; color: #c33; padding: 15px; margin-bottom: 20px; border-radius: 6px;">
            <strong>Error:</strong> <%= error %>
          </div>
          <% } %>
          
          <% if (typeof message !== 'undefined' && message) { %>
          <div class="alert alert-info" style="background-color: #e7f3ff; border: 1px solid #b8daff; color: #004085; padding: 15px; margin-bottom: 20px; border-radius: 6px;">
            <%= message %>
          </div>
          <% } %>

          <!-- Upcoming Tour Bookings -->
          <div class="trips-section">
            <div class="section-header">
              <h2 class="section-title">
                <i class="fas fa-clock"></i> Upcoming Tours
              </h2>
            </div>
            <div class="trips-grid">
              <% if (bookings && Array.isArray(bookings)) { %>
                <% let hasUpcoming = false; %>
                <% bookings.forEach(booking => { %>
                  <% if (booking && (booking.bookingDetails?.status == "upcoming" || booking.bookingDetails?.status == "pending")) { %>
                    <% hasUpcoming = true; %>
                    <div class="trip-card">
                      <div style="position: relative">
                        <img
                          src="<%= booking.itemId?.mainImage || '/images/default-tour.jpg' %>"
                          alt="<%= booking.itemId?.title || 'Tour' %>"
                          class="trip-image"
                        />
                        <div class="trip-status status-upcoming">
                          <%= booking.bookingDetails?.status === 'pending' ? 'Pending' : 'Upcoming' %>
                        </div>
                      </div>
                      <div class="trip-content">
                        <div class="trip-date">
                          <span>üìÖ</span> 
                          <% if (booking.bookingDetails?.startDate) { %>
                            Start Date: <%= new Date(booking.bookingDetails.startDate).toLocaleDateString() %>
                          <% } else { %>
                            Booking Date: <%= new Date(booking.createdAt || Date.now()).toLocaleDateString() %>
                          <% } %>
                        </div>
                        <h3 class="trip-title">
                          <%= booking.itemId?.title || 'Tour Booking' %>
                        </h3>
                        <div class="trip-destination">
                          <span>üìç</span> <%= booking.itemId?.startLocation || booking.itemId?.location || 'Location not available' %>
                        </div>

                        <div class="trip-stats">
                          <div class="stat">
                            <div class="stat-value">
                              <%= booking.itemId?.itinerary?.length || booking.itemId?.duration?.split(' ')[0] || 'N/A' %>
                            </div>
                            <div class="stat-label">Days</div>
                          </div>
                          <div class="stat">
                            <div class="stat-value">
                              <%= booking.itemId?.destinations?.length || 'N/A' %>
                            </div>
                            <div class="stat-label">Destinations</div>
                          </div>
                          <div class="stat">
                            <div class="stat-value">
                              <% let activityCount = 0; %>
                              <% if (booking.itemId?.itinerary) { %>
                                <% booking.itemId.itinerary.forEach(day => { %>
                                  <% activityCount += day.activities?.length || 0; %>
                                <% }); %>
                              <% } %>
                              <%= activityCount || 'N/A' %>
                            </div>
                            <div class="stat-label">Activities</div>
                          </div>
                        </div>

                        <div class="trip-actions">
                          <button
                            data-itemId="<%= booking.itemId?._id %>"
                            data-bookingId="<%= booking._id %>"
                            class="trip-action-btn btn-outline cancel-trip"
                          >
                            Cancel
                          </button>
                          <button
                            onclick="window.location.href = '/tours/tour/<%= booking.itemId?._id %>'"
                            class="trip-action-btn btn-primary"
                          >
                            View Tour
                          </button>
                        </div>
                      </div>
                    </div>
                  <% } %>
                <% }); %>
                
                <% if (!hasUpcoming) { %>
                  <div class="empty-state" style="text-align: center; padding: 40px; color: #666;">
                    <i class="fas fa-map-marked-alt" style="font-size: 48px; margin-bottom: 16px; color: #ddd;"></i>
                    <p>No upcoming tour bookings found.</p>
                    <button
                      onclick="window.location.href = '/tours'"
                      class="btn btn-primary"
                      style="margin-top: 16px;"
                    >
                      Browse Tours
                    </button>
                  </div>
                <% } %>
              <% } else { %>
                <div class="empty-state" style="text-align: center; padding: 40px; color: #666;">
                  <i class="fas fa-map-marked-alt" style="font-size: 48px; margin-bottom: 16px; color: #ddd;"></i>
                  <p>No tour bookings found.</p>
                  <button
                    onclick="window.location.href = '/tours'"
                    class="btn btn-primary"
                    style="margin-top: 16px;"
                  >
                    Browse Tours
                  </button>
                </div>
              <% } %>
            </div>
          </div>

          <!-- Past Tour Bookings -->
          <div class="past-trips-section">
            <div class="section-header">
              <h2 class="section-title">
                <i class="fas fa-history"></i> Past Tours
              </h2>
              <a href="#" class="section-link">View All</a>
            </div>

            <div class="trips-grid">
              <% if (bookings && Array.isArray(bookings)) { %>
                <% let hasPast = false; %>
                <% bookings.forEach(booking => { %>
                  <% if (booking && (booking.bookingDetails?.status == "completed" || booking.bookingDetails?.status == "cancel")) { %>
                    <% hasPast = true; %>
                    <div class="trip-card">
                      <div style="position: relative">
                        <img
                          src="<%= booking.itemId?.mainImage || '/images/default-tour.jpg' %>"
                          alt="<%= booking.itemId?.title || 'Tour' %>"
                          class="trip-image"
                        />
                        <div class="trip-status <%= booking.bookingDetails?.status === 'cancel' ? 'status-cancelled' : 'status-completed' %>">
                          <%= booking.bookingDetails?.status === 'cancel' ? 'Cancelled' : 'Completed' %>
                        </div>
                      </div>
                      <div class="trip-content">
                        <div class="trip-date">
                          <span>üìÖ</span> 
                          <% if (booking.bookingDetails?.startDate) { %>
                            Start Date: <%= new Date(booking.bookingDetails.startDate).toLocaleDateString() %>
                          <% } else { %>
                            Booking Date: <%= new Date(booking.createdAt || Date.now()).toLocaleDateString() %>
                          <% } %>
                        </div>
                        <h3 class="trip-title">
                          <%= booking.itemId?.title || 'Tour Booking' %>
                        </h3>
                        <div class="trip-destination">
                          <span>üìç</span> <%= booking.itemId?.startLocation || booking.itemId?.location || 'Location not available' %>
                        </div>

                        <% if (booking.bookingDetails?.status === 'completed') { %>
                        <div class="trip-actions">
                          <button
                            onclick="window.location.href = '/tours/tour/<%= booking.itemId?._id %>'"
                            class="trip-action-btn btn-outline"
                          >
                            View Tour
                          </button>
                          <button class="trip-action-btn btn-primary">
                            Add Review
                          </button>
                        </div>
                        <% } %>
                      </div>
                    </div>
                  <% } %>
                <% }); %>
                
                <% if (!hasPast) { %>
                  <div class="empty-state" style="text-align: center; padding: 40px; color: #666;">
                    <i class="fas fa-history" style="font-size: 48px; margin-bottom: 16px; color: #ddd;"></i>
                    <p>No past tour bookings found.</p>
                  </div>
                <% } %>
              <% } else { %>
                <div class="empty-state" style="text-align: center; padding: 40px; color: #666;">
                  <i class="fas fa-history" style="font-size: 48px; margin-bottom: 16px; color: #ddd;"></i>
                  <p>No past tour bookings found.</p>
                </div>
              <% } %>
            </div>
          </div>
        </main>
      </div>
    </div>
  </body>
</html>
